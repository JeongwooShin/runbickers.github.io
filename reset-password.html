<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>비밀번호 재설정 | RunBickers</title>
    <meta name="description" content="RunBickers 비밀번호 재설정 페이지" />
    <link rel="canonical" href="https://jeongwooshin.github.io/runbickers.github.io/reset-password.html" />
    <style>
      :root { color-scheme: light dark; }
      body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, sans-serif; margin: 0; padding: 0; }
      .wrap { max-width: 420px; margin: 8vh auto; padding: 24px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.08); }
      h1 { font-size: 22px; margin: 0 0 16px; }
      p { line-height: 1.6; }
      form { display: grid; gap: 12px; margin-top: 12px; }
      label { font-size: 14px; }
      input { width: 100%; padding: 10px 12px; border: 1px solid #d0d5dd; border-radius: 8px; font-size: 16px; }
      button { padding: 12px 14px; border: 0; border-radius: 8px; font-weight: 600; background: #4f46e5; color: white; cursor: pointer; }
      button:disabled { opacity: .6; cursor: not-allowed; }
      .notice { padding: 12px; border-radius: 8px; background: #f1f5f9; font-size: 14px; }
      .error { color: #b42318; }
      .success { color: #027a48; }
      .footer { margin-top: 16px; font-size: 12px; color: #667085; }
      .hidden { display: none; }
    </style>
  </head>
  <body>
    <main class="wrap" role="main">
      <h1>비밀번호 재설정</h1>
      <div id="status" class="notice">이메일 링크를 확인하는 중입니다...</div>

      <form id="resetForm" class="hidden" autocomplete="off">
        <div>
          <label for="password">새 비밀번호</label>
          <input id="password" name="password" type="password" required minlength="6" placeholder="새 비밀번호를 입력하세요" />
        </div>
        <div>
          <label for="confirm">새 비밀번호 확인</label>
          <input id="confirm" name="confirm" type="password" required minlength="6" placeholder="한번 더 입력하세요" />
        </div>
        <button id="submitBtn" type="submit">비밀번호 변경</button>
      </form>

      <p id="done" class="hidden success">비밀번호가 변경되었습니다. 앱으로 돌아가 로그인해주세요.</p>
      <p id="error" class="hidden error"></p>

      <p class="footer">문제가 계속되면 비밀번호 재설정을 다시 요청하거나 관리자에게 문의하세요.</p>
    </main>

    <script type="module">
      import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

      // Supabase 프로젝트 설정
      const SUPABASE_URL = 'https://sragibpyggwxbghyfuzq.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyYWdpYnB5Z2d3eGJnaHlmdXpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMTYwMTYsImV4cCI6MjA2ODU5MjAxNn0.oOKRCaMs42f-LD8DclL_tXimCIY5OOKWuSHerIOj8-0';

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: { persistSession: false },
      });

      const qs = new URLSearchParams(location.hash.replace(/^#/, ''));
      const access_token = qs.get('access_token');
      const refresh_token = qs.get('refresh_token');
      const type = qs.get('type');

      const statusEl = document.getElementById('status');
      const formEl = document.getElementById('resetForm');
      const doneEl = document.getElementById('done');
      const errorEl = document.getElementById('error');
      const submitBtn = document.getElementById('submitBtn');

      function show(el) { el.classList.remove('hidden'); }
      function hide(el) { el.classList.add('hidden'); }

      async function init() {
        try {
          if (type !== 'recovery') {
            statusEl.textContent = '유효하지 않은 링크입니다. 비밀번호 재설정을 다시 요청해주세요.';
            return;
          }

          if (!access_token || !refresh_token) {
            statusEl.textContent = '토큰이 누락되었습니다. 메일의 링크를 다시 클릭하거나 재요청하세요.';
            return;
          }

          // 전달된 토큰으로 세션 설정
          const { data, error } = await supabase.auth.setSession({ access_token, refresh_token });
          if (error) throw error;

          statusEl.textContent = '새 비밀번호를 입력하세요.';
          show(formEl);

          formEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            hide(errorEl); hide(doneEl);
            submitBtn.disabled = true;

            const password = /** @type {HTMLInputElement} */(document.getElementById('password')).value.trim();
            const confirm = /** @type {HTMLInputElement} */(document.getElementById('confirm')).value.trim();
            if (password.length < 6) {
              errorEl.textContent = '비밀번호는 6자 이상이어야 합니다.'; show(errorEl); submitBtn.disabled = false; return;
            }
            if (password !== confirm) {
              errorEl.textContent = '비밀번호가 일치하지 않습니다.'; show(errorEl); submitBtn.disabled = false; return;
            }

            const { error: updErr } = await supabase.auth.updateUser({ password });
            if (updErr) {
              errorEl.textContent = `변경 실패: ${updErr.message}`; show(errorEl); submitBtn.disabled = false; return;
            }

            hide(formEl);
            statusEl.textContent = '';
            show(doneEl);
          }, { once: true });
        } catch (err) {
          console.error(err);
          statusEl.textContent = '오류가 발생했습니다. 비밀번호 재설정을 다시 시도해주세요.';
          errorEl.textContent = err?.message ?? String(err);
          show(errorEl);
        }
      }

      init();
    </script>
  </body>
</html>

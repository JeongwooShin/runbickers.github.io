<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>비밀번호 재설정 | RunBickers</title>
    <meta name="description" content="RunBickers 비밀번호 재설정 페이지" />
    <link rel="canonical" href="https://jeongwooshin.github.io/runbickers.github.io/reset-password.html" />
    <style>
      :root { color-scheme: light dark; }
      body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, sans-serif; margin: 0; padding: 0; background: #f7f7f8; }
      .wrap { max-width: 480px; margin: 8vh auto; padding: 24px; border-radius: 12px; background: #fff; box-shadow: 0 10px 30px rgba(0,0,0,.08); }
      h1 { font-size: 22px; margin: 0 0 16px; }
      p { line-height: 1.6; margin: 0 0 12px; }
      form { display: grid; gap: 12px; margin-top: 12px; }
      label { font-size: 14px; }
      input { width: 100%; padding: 10px 12px; border: 1px solid #d0d5dd; border-radius: 8px; font-size: 16px; }
      button { padding: 12px 14px; border: 0; border-radius: 8px; font-weight: 600; background: #4f46e5; color: white; cursor: pointer; }
      button:disabled { opacity: .6; cursor: not-allowed; }
      .notice { padding: 12px; border-radius: 8px; background: #f1f5f9; font-size: 14px; color: #0f172a; }
      .msg { padding: 10px 12px; border-radius: 8px; font-size: 14px; }
      .ok { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0 }
      .err { background:#fef2f2; color:#991b1b; border:1px solid #fecaca }
      .footer { margin-top: 16px; font-size: 12px; color: #667085; }
      .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; word-break: break-all; }
      .hidden { display: none; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <main class="wrap" role="main">
      <h1>비밀번호 재설정</h1>
      <div id="status" class="notice">이메일 링크를 확인하는 중입니다…</div>

      <!-- OTP(이메일 토큰)만 온 경우 이메일을 받아 검증 -->
      <form id="emailForm" class="hidden" autocomplete="off">
        <div>
          <label for="email">계정 이메일</label>
          <input id="email" name="email" type="email" required placeholder="가입한 이메일 주소" />
        </div>
        <button id="emailBtn" type="submit">이메일 확인</button>
      </form>

      <!-- 실제 비밀번호 변경 폼 -->
      <form id="resetForm" class="hidden" autocomplete="off">
        <div>
          <label for="password">새 비밀번호</label>
          <input id="password" name="password" type="password" required minlength="8" placeholder="최소 8자" />
        </div>
        <div>
          <label for="confirm">새 비밀번호 확인</label>
          <input id="confirm" name="confirm" type="password" required minlength="8" placeholder="한번 더 입력" />
        </div>
        <button id="submitBtn" type="submit">비밀번호 변경</button>
      </form>

      <p id="done" class="msg ok hidden">비밀번호가 변경되었습니다. 앱으로 돌아가 로그인해주세요.</p>
      <p id="error" class="msg err hidden"></p>

      <div class="footer">
        문제가 계속되면 비밀번호 재설정을 다시 요청하거나 관리자에게 문의하세요.
        <div id="debug" class="mono" aria-hidden="true"></div>
      </div>
    </main>

    <script>
      // 본인 Supabase 프로젝트 설정
      const SUPABASE_URL = "https://sragibpyggwxbghyfuzq.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyYWdpYnB5Z2d3eGJnaHlmdXpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMTYwMTYsImV4cCI6MjA2ODU5MjAxNn0.oOKRCaMs42f-LD8DclL_tXimCIY5OOKWuSHerIOj8-0";
      const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });

      const $ = (id) => document.getElementById(id);
      const statusEl = $("status");
      const emailForm = $("emailForm");
      const resetForm = $("resetForm");
      const doneEl = $("done");
      const errorEl = $("error");
      const submitBtn = $("submitBtn");
      const emailBtn = $("emailBtn");
      const debugEl = $("debug");

      function show(el){ el.classList.remove("hidden"); }
      function hide(el){ el.classList.add("hidden"); }
      const isJWT = (t) => typeof t === "string" && t.split(".").length === 3;

      // 쿼리와 해시 둘 다에서 파라미터 수집
      function collectParams() {
        const url = new URL(location.href);
        const sp = url.searchParams;
        const hp = new URLSearchParams(url.hash.startsWith("#") ? url.hash.slice(1) : url.hash);
        const get = (k) => sp.get(k) || hp.get(k);
        const out = {
          href: url.toString(),
          type: get("type"),
          code: get("code"),
          access_token: get("access_token"),
          refresh_token: get("refresh_token"),
          token: get("token"), // 일부 환경
        };
        // 해시 내부 쿼리까지 백업 파싱
        if (!out.access_token && url.hash.includes("access_token=")) {
          const m = url.hash.match(/access_token=([^&#]+)/); if (m) out.access_token = m[1];
        }
        if (!out.refresh_token && url.hash.includes("refresh_token=")) {
          const m = url.hash.match(/refresh_token=([^&#]+)/); if (m) out.refresh_token = m[1];
        }
        if (!out.type && url.hash.includes("type=")) {
          const m = url.hash.match(/type=([^&#]+)/); if (m) out.type = m[1];
        }
        if (!out.code && url.hash.includes("code=")) {
          const m = url.hash.match(/code=([^&#]+)/); if (m) out.code = m[1];
        }
        return out;
      }

      async function updatePasswordWithBearer(access_token, newPassword){
        const res = await fetch(SUPABASE_URL + "/auth/v1/user", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": "Bearer " + access_token,
          },
          body: JSON.stringify({ password: newPassword }),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err?.msg || err?.message || ("HTTP " + res.status));
        }
      }

      async function bootstrap(){
        const p = collectParams();
        debugEl.textContent = p.href;

        // recovery만 허용(누락 시 recovery로 간주)
        const isRecovery = (p.type || "recovery") === "recovery";
        if (!isRecovery) {
          statusEl.textContent = "이 링크는 비밀번호 재설정(recovery) 링크가 아닙니다.";
          return;
        }

        try {
          let mode = ""; // "session", "bearer-only", "otp-email"
          let bearerAccess = null;

          if (p.code) {
            // PKCE 코드 → 세션 교환
            const { error } = await client.auth.exchangeCodeForSession(p.code);
            if (error) throw error;
            mode = "session";
          } else {
            const raw = p.access_token || p.token || "";
            if (raw && isJWT(raw) && p.refresh_token) {
              // 완전한 토큰 쌍
              const { error } = await client.auth.setSession({
                access_token: raw,
                refresh_token: p.refresh_token,
              });
              if (error) throw error;
              mode = "session";
            } else if (raw && isJWT(raw) && !p.refresh_token) {
              // JWT만 온 경우 → 세션 없이 Bearer로 직접 업데이트
              bearerAccess = raw;
              mode = "bearer-only";
            } else if (raw && !isJWT(raw)) {
              // OTP 토큰(지금 상황) → 이메일 받아 verifyOtp 후 세션 확보
              mode = "otp-email";
            } else {
              throw new Error("토큰 정보를 찾지 못했습니다. 링크가 만료되었거나 변형되었습니다.");
            }
          }

          if (mode === "otp-email") {
            statusEl.textContent = "계정 이메일을 확인해 주세요.";
            show(emailForm);

            emailForm.addEventListener("submit", async (e) => {
              e.preventDefault();
              hide(errorEl); hide(doneEl);
              emailBtn.disabled = true;
              const email = /** @type {HTMLInputElement} */(document.getElementById("email")).value.trim();
              try {
                const token = p.access_token || p.token;
                const { error } = await client.auth.verifyOtp({ type: "recovery", email, token });
                if (error) throw error;
                // 세션이 생겼으므로 비번 폼 노출
                hide(emailForm);
                statusEl.textContent = "새 비밀번호를 입력하세요.";
                show(resetForm);
              } catch (e) {
                errorEl.textContent = e?.message || String(e);
                show(errorEl);
              } finally {
                emailBtn.disabled = false;
              }
            }, { once: true });

            return; // 여기서 종료, 이어서 사용자 입력 대기
          }

          // 세션이 있거나(bearer-only 포함) → 비밀번호 폼 노출
          statusEl.textContent = "새 비밀번호를 입력하세요.";
          show(resetForm);

          resetForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            hide(errorEl); hide(doneEl);
            submitBtn.disabled = true;

            const pw1 = /** @type {HTMLInputElement} */(document.getElementById("password")).value.trim();
            const pw2 = /** @type {HTMLInputElement} */(document.getElementById("confirm")).value.trim();

            if (pw1.length < 8) { errorEl.textContent = "비밀번호는 8자 이상이어야 합니다."; show(errorEl); submitBtn.disabled = false; return; }
            if (pw1 !== pw2) { errorEl.textContent = "비밀번호가 일치하지 않습니다."; show(errorEl); submitBtn.disabled = false; return; }

            try {
              if (mode === "bearer-only" && bearerAccess) {
                await updatePasswordWithBearer(bearerAccess, pw1);
              } else {
                const { error } = await client.auth.updateUser({ password: pw1 });
                if (error) throw error;
              }
              hide(resetForm);
              statusEl.textContent = "";
              show(doneEl);
            } catch (e) {
              errorEl.textContent = e?.message || String(e);
              show(errorEl);
            } finally {
              submitBtn.disabled = false;
            }
          }, { once: true });

        } catch (e) {
          statusEl.textContent = "오류가 발생했습니다. 비밀번호 재설정을 다시 시도해주세요.";
          errorEl.textContent = e?.message || String(e);
          show(errorEl);
        }
      }

      bootstrap();
    </script>
  </body>
</html>

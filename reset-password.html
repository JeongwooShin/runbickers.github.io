<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>비밀번호 재설정 | Runbickers</title>
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f7f7f8;margin:0}
      .wrap{max-width:420px;margin:60px auto;padding:24px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.05)}
      h1{font-size:20px;margin:0 0 8px}
      p{color:#4b5563;margin:0 0 16px;font-size:14px;line-height:1.5}
      label{display:block;margin:12px 0 6px;font-weight:600}
      input{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:14px}
      button{width:100%;margin-top:16px;padding:12px 14px;background:#111827;color:#fff;border:0;border-radius:10px;font-size:15px;cursor:pointer}
      button[disabled]{opacity:.6;cursor:not-allowed}
      .msg{margin:12px 0;padding:10px 12px;border-radius:8px;font-size:14px}
      .ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
      .err{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
      .hidden{display:none}
      .footer{margin-top:20px;text-align:center;color:#6b7280;font-size:12px}
      .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <div class="wrap">
      <h1>비밀번호 재설정</h1>
      <p id="status">링크 검증 중입니다…</p>

      <div id="form-wrap" class="hidden">
        <form id="reset-form">
          <label for="pw1">새 비밀번호</label>
          <input id="pw1" type="password" minlength="8" placeholder="최소 8자" required />
          <label for="pw2">새 비밀번호 확인</label>
          <input id="pw2" type="password" minlength="8" placeholder="다시 입력" required />
          <button id="submit-btn" type="submit">비밀번호 변경</button>
        </form>
        <div id="msg" class="msg hidden"></div>
      </div>

      <div class="footer">
        <div>문제가 있나요? 링크 전체를 복사해 개발자에게 보내주세요.</div>
        <div class="mono" id="debug"></div>
      </div>
    </div>

    <script>
      // 1) 본인 프로젝트 값으로 교체
      const SUPABASE_URL = "https://sragibpyggwxbghyfuzq.supabase.co"; // 본인 프로젝트 URL
      const SUPABASE_ANON_KEY = "PASTE_YOUR_ANON_KEY_HERE"; // 본인 anon 키(공개키)
      const client = supabase.createClient(https://sragibpyggwxbghyfuzq.supabase.co, eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyYWdpYnB5Z2d3eGJnaHlmdXpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMTYwMTYsImV4cCI6MjA2ODU5MjAxNn0.oOKRCaMs42f-LD8DclL_tXimCIY5OOKWuSHerIOj8-0);

      const $ = (id) => document.getElementById(id);
      const statusEl = $("status");
      const formWrap = $("form-wrap");
      const msgEl = $("msg");
      const debugEl = $("debug");
      const formEl = $("reset-form");
      const pw1El = $("pw1");
      const pw2El = $("pw2");
      const submitBtn = $("submit-btn");

      function showMsg(text, ok=false){
        msgEl.textContent = text;
        msgEl.className = "msg " + (ok ? "ok" : "err");
        msgEl.classList.remove("hidden");
      }

      function parseParams(){
        const url = new URL(window.location.href);
        // 우선 search, 그 다음 hash도 검사
        const sp = url.searchParams;
        const hp = new URLSearchParams(url.hash.startsWith("#") ? url.hash.slice(1) : url.hash);

        const get = (k) => sp.get(k) || hp.get(k);
        let access_token = get("access_token");
        let refresh_token = get("refresh_token");
        let type = get("type");
        let code = get("code");

        // 해시 내부에 완전히 묻은 경우까지 정규식으로도 한번 더
        if (!access_token && url.hash.includes("access_token=")) {
          const m = url.hash.match(/access_token=([^&]+)/); if (m) access_token = m[1];
        }
        if (!refresh_token && url.hash.includes("refresh_token=")) {
          const m = url.hash.match(/refresh_token=([^&]+)/); if (m) refresh_token = m[1];
        }
        if (!type && url.hash.includes("type=")) {
          const m = url.hash.match(/type=([^&]+)/); if (m) type = m[1];
        }
        if (!code && url.hash.includes("code=")) {
          const m = url.hash.match(/code=([^&]+)/); if (m) code = m[1];
        }

        return { access_token, refresh_token, type, code, href: url.toString() };
      }

      async function bootstrap(){
        const { access_token, refresh_token, type, code, href } = parseParams();
        debugEl.textContent = href;

        if (type !== "recovery") {
          statusEl.textContent = "이 링크는 비밀번호 재설정(recovery) 링크가 아닙니다.";
          showMsg("잘못된 링크이거나 만료되었습니다.", false);
          return;
        }

        try {
          // 2) 세션 복원: 토큰 방식 우선, 아니면 code(PKCE) 방식
          let setErr = null;
          if (access_token && refresh_token) {
            const { error } = await client.auth.setSession({
              access_token,
              refresh_token,
            });
            setErr = error;
          } else if (code) {
            const { error } = await client.auth.exchangeCodeForSession(code);
            setErr = error;
          } else {
            statusEl.textContent = "토큰 정보를 찾지 못했습니다.";
            showMsg("토큰이 누락되었거나 만료되었습니다. 링크를 다시 요청하세요.", false);
            return;
          }

          if (setErr) {
            statusEl.textContent = "세션 복구 실패";
            showMsg(setErr.message || "세션 복구 실패", false);
            return;
          }

          // 3) 폼 표시
          statusEl.textContent = "새 비밀번호를 입력하세요.";
          formWrap.classList.remove("hidden");

          formEl.addEventListener("submit", async (e) => {
            e.preventDefault();
            const pw1 = pw1El.value.trim();
            const pw2 = pw2El.value.trim();

            if (pw1.length < 8) { showMsg("비밀번호는 8자 이상이어야 합니다.", false); return; }
            if (pw1 !== pw2) { showMsg("비밀번호가 일치하지 않습니다.", false); return; }

            submitBtn.disabled = true;
            const { error } = await client.auth.updateUser({ password: pw1 });
            submitBtn.disabled = false;

            if (error) {
              showMsg(error.message || "비밀번호 변경 실패", false);
            } else {
              showMsg("비밀번호가 변경되었습니다. 이제 앱에서 로그인하세요.", true);
            }
          });
        } catch (e) {
          statusEl.textContent = "오류가 발생했습니다.";
          showMsg(e.message || "알 수 없는 오류", false);
        }
      }

      bootstrap();
    </script>
  </body>
</html>

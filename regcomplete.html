<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>가입 완료</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; margin: 24px; line-height: 1.5; }
    .card { max-width: 720px; margin: 0 auto; border: 1px solid #ddd; border-radius: 10px; padding: 20px; background: #fff3; backdrop-filter: blur(2px); }
    h1 { margin: 0 0 6px 0; font-size: 20px; }
    .muted { color: #666; font-size: 14px; margin-top: 2px; }
    .log { margin-top: 16px; padding: 12px; border-radius: 8px; background: #f6f8fa; font-size: 13px; white-space: pre-wrap; word-break: break-all; }
    .ok { color: #0a7f2e; }
    .warn { color: #a15a00; }
    .err { color: #b00020; }
    .row { margin-top: 12px; }
    button, a.btn { display: inline-block; padding: 10px 14px; border-radius: 8px; border: 1px solid #2f6feb; color: #fff; background: #2f6feb; text-decoration: none; cursor: pointer; }
    .ghost { background: transparent; color: #2f6feb; }
    .actions { display: flex; gap: 8px; margin-top: 14px; }
    code { background: #0001; padding: 2px 6px; border-radius: 6px; }
  </style>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // 1) 본인 프로젝트 값으로 교체
    const SUPABASE_URL = 'https://sragibpyggwxbghyfuzq.supabase.co'; // 예시: https://<ref>.supabase.co
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyYWdpYnB5Z2d3eGJnaHlmdXpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMTYwMTYsImV4cCI6MjA2ODU5MjAxNn0.oOKRCaMs42f-LD8DclL_tXimCIY5OOKWuSHerIOj8-0';            // 예시: eyJhbGciOiJIUzI1NiIsInR...

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI helpers
    const $ = (sel) => document.querySelector(sel);
    const log = (msg, cls = '') => {
      const el = document.createElement('div');
      el.textContent = msg;
      if (cls) el.className = cls;
      $('#log').appendChild(el);
    };

    // URL/Hash 파라미터 파서
    const qs = new URLSearchParams(location.search);
    const hs = new URLSearchParams(location.hash.replace(/^#/, ''));

    function getReferralCode() {
      // URL 우선(rc, ref, referralCode), 없으면 로컬스토리지
      const fromUrl = qs.get('rc') || qs.get('ref') || qs.get('referralCode');
      const fromHash = hs.get('rc') || hs.get('ref') || hs.get('referralCode');
      const fromLS = localStorage.getItem('pendingReferralCode');
      const rc = (fromUrl || fromHash || fromLS || '').trim();
      if (rc) {
        // 다음 페이지 방문 시에도 사용할 수 있게 저장(중복 저장 무해)
        localStorage.setItem('pendingReferralCode', rc);
      }
      return rc;
    }

    async function ensureSession() {
      // 1) 이미 세션 있는지
      let { data: { session } } = await supabase.auth.getSession();
      if (session) return session;

      // 2) code 쿼리 파라미터가 있으면 교환
      const code = qs.get('code') || hs.get('code');
      if (code) {
        try {
          const { data, error } = await supabase.auth.exchangeCodeForSession(code);
          if (error) throw error;
          return data.session ?? null;
        } catch (e) {
          log(`세션 교환 실패(code): ${e.message}`, 'err');
        }
      }

      // 3) access_token / refresh_token 해시로 전달된 경우
      const at = hs.get('access_token');
      const rt = hs.get('refresh_token');
      if (at && rt) {
        try {
          const { data, error } = await supabase.auth.setSession({ access_token: at, refresh_token: rt });
          if (error) throw error;
          return data.session ?? null;
        } catch (e) {
          log(`세션 설정 실패(hash tokens): ${e.message}`, 'err');
        }
      }

      // 4) 마지막 재시도
      ({ data: { session } } = await supabase.auth.getSession());
      return session ?? null;
    }

    async function applyReferralIfNeeded() {
      const rc = getReferralCode();
      if (!rc) {
        log('추천 코드가 감지되지 않았습니다(rc/ref/referralCode).', 'warn');
      } else {
        log(`감지된 추천 코드: ${rc}`, 'ok');
      }

      const session = await ensureSession();

      if (!session) {
        log('세션이 없습니다. 로그인 후 다시 시도해주세요.', 'err');
        return;
      }

      // 이메일 확인용
      const { data: userData, error: userErr } = await supabase.auth.getUser();
      const email = userData?.user?.email || '(unknown)';
      if (userErr) {
        log(`사용자 정보 조회 실패: ${userErr.message}`, 'err');
      } else {
        log(`인증된 사용자: ${email}`, 'ok');
      }

      // 추천코드가 없으면 여기서 종료(회원가입 화면에서 입력 안 했을 가능성)
      if (!rc) return;

      // 이미 최근 24시간 내 트랜잭션이 있으면 스킵(과도한 중복 호출 방지)
      try {
        const since = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
        const { data: tx, error: txErr } = await supabase
          .from('coin_transactions')
          .select('id')
          .gte('created_at', since)
          .limit(1);
        if (!txErr && tx && tx.length > 0) {
          log('최근 트랜잭션이 이미 존재하여 추천 보정 호출을 생략합니다.', 'warn');
          return;
        }
      } catch {
        // 조회 실패해도 계속 시도
      }

      // Functions(process-referral) 호출
      log('추천 보상 처리 시도 중...', '');
      try {
        // supabase-js v2는 현재 세션의 JWT를 Authorization 헤더에 자동 추가합니다.
        const { data, error } = await supabase.functions.invoke('process-referral', {
          body: { referralCode: rc }
        });

        if (error) {
          // 에러 메시지 친화적으로 처리
          const msg = (error?.message || '').toLowerCase();
          if (msg.includes('already') || msg.includes('이미')) {
            log('이미 추천이 적용된 사용자입니다(중복 보상 없음).', 'warn');
          } else if (msg.includes('invalid referral')) {
            log('추천 코드가 유효하지 않습니다.', 'err');
          } else if (msg.includes('unauthorized')) {
            log('인증이 필요합니다. 다시 로그인 후 시도해주세요.', 'err');
          } else {
            log(`추천 처리 실패: ${error.message}`, 'err');
          }
        } else if (data?.success) {
          log(`추천 보상이 적용되었습니다. 추천인(+${data.referrerReward}), 피추천인(+${data.refereeReward})`, 'ok');
          // 한 번 적용되면 보류 코드 삭제
          localStorage.removeItem('pendingReferralCode');
        } else {
          log('추천 처리 결과를 확인할 수 없습니다.', 'warn');
        }
      } catch (e) {
        log(`추천 처리 호출 실패: ${e.message}`, 'err');
      }
    }

    window.addEventListener('DOMContentLoaded', async () => {
      // 화면 표시
      log('가입 인증이 완료되었습니다.', 'ok');
      log('필요 시 추천 코드 적용을 보정합니다...', '');

      // 메인 동작
      await applyReferralIfNeeded();

      // 선택: 몇 초 후 앱 메인으로 이동하고 싶다면 주석 해제
      // setTimeout(() => {
      //   location.href = new URL('./', location.href).toString();
      // }, 1500);
    });
  </script>
</head>
<body>
  <div class="card">
    <h1>가입이 완료되었습니다</h1>
    <div class="muted">Your registration has completed.</div>

    <div class="row">
      <div id="log" class="log" role="status" aria-live="polite"></div>
    </div>

    <div class="actions">
      <a class="btn" href="./">앱으로 이동</a>
      <a class="btn ghost" href="./index.html">홈으로</a>
    </div>

    <div class="row muted">
      참고:
      <ul>
        <li>추천 코드가 URL(rc/ref/referralCode) 또는 브라우저 저장소에 있을 경우 자동으로 처리합니다.</li>
        <li>이미 보상이 적용된 이메일(글로벌 1회 정책)은 추가 지급되지 않습니다.</li>
      </ul>
    </div>
  </div>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>가입 완료</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; margin:24px; line-height:1.6; }
    .card { max-width: 720px; margin: 0 auto; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; background: #fff; }
    h1 { margin: 0 0 8px; font-size: 20px; }
    .muted { color: #6b7280; font-size: 14px; }
    .status { margin-top: 14px; padding: 12px; border-radius: 10px; background: #f8fafc; font-size: 14px; }
    .ok  { color: #065f46; background: #ecfdf5; }
    .warn{ color: #7c2d12; background: #fff7ed; }
    .err { color: #991b1b; background: #fef2f2; }
    .actions { display:flex; gap:10px; margin-top:16px; }
    .btn { display:inline-block; padding:10px 14px; border-radius:8px; border:1px solid #2563eb; color:#fff; background:#2563eb; text-decoration:none; }
    .ghost { background:#fff; color:#2563eb; }
    .small { font-size: 12px; color:#6b7280; margin-top:10px; }
  </style>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // 프로젝트 설정
    const SUPABASE_URL = 'https://sragibpyggwxbghyfuzq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyYWdpYnB5Z2d3eGJnaHlmdXpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMTYwMTYsImV4cCI6MjA2ODU5MjAxNn0.oOKRCaMs42f-LD8DclL_tXimCIY5OOKWuSHerIOj8-0';
    const FUNCTIONS_PROXY = `${SUPABASE_URL}/functions/v1`;

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $ = (s)=>document.querySelector(s);

    const qs = new URLSearchParams(location.search);
    const hs = new URLSearchParams(location.hash.replace(/^#/, ''));

    function setStatus(text, cls='') {
      const el = $('#status');
      el.className = `status ${cls}`;
      el.textContent = text;
    }

    function b64urlToStr(b64url) { try { let s=b64url.replace(/-/g,'+').replace(/_/g,'/'); const pad=s.length%4; if(pad) s+='='.repeat(4-pad); return atob(s);} catch { return ''; } }
    function parseJwtPayload(token) { try { const p=token.split('.'); if(p.length<2) return null; const j=b64urlToStr(p[1]); return j?JSON.parse(j):null; } catch { return null; } }

    function readReferralFromUrlOrLS() {
      const fromUrl=qs.get('rc')||qs.get('ref')||qs.get('referralCode');
      const fromHash=hs.get('rc')||hs.get('ref')||hs.get('referralCode');
      const fromLS=localStorage.getItem('pendingReferralCode');
      const rc=(fromUrl||fromHash||fromLS||'').trim();
      if(rc) localStorage.setItem('pendingReferralCode', rc);
      return rc;
    }
    function readReferralFromJWT() {
      const at=hs.get('access_token'); if(!at) return '';
      const payload=parseJwtPayload(at);
      const rc=payload?.user_metadata?.referralCode||payload?.user_metadata?.referralcode||'';
      return (rc||'').trim();
    }

    async function ensureSession() {
      let { data:{ session } } = await supabase.auth.getSession();
      if (session) return session;

      const code = qs.get('code') || hs.get('code');
      if (code) {
        const { data, error } = await supabase.auth.exchangeCodeForSession(code);
        if (!error && data?.session) return data.session;
      }

      const at = hs.get('access_token'); const rt = hs.get('refresh_token');
      if (at && rt) {
        const { data, error } = await supabase.auth.setSession({ access_token: at, refresh_token: rt });
        if (!error && data?.session) return data.session;
      }

      ({ data:{ session } } = await supabase.auth.getSession());
      return session ?? null;
    }

    async function detectReferralCode() {
      let rc = readReferralFromUrlOrLS(); if (rc) return rc;
      rc = readReferralFromJWT(); if (rc) return rc;
      try {
        const { data: ud } = await supabase.auth.getUser();
        const rcMeta=(ud?.user?.user_metadata?.referralCode||'').trim();
        if (rcMeta) return rcMeta;
      } catch {}
      return '';
    }

    async function getAdminRewardsFallback() {
      // 프런트에서 admin_settings를 읽을 수 없을 수도 있으므로 조용히 시도 후 실패해도 무시
      try {
        const { data } = await supabase
          .from('admin_settings')
          .select('key,value')
          .in('key',['referral_referrer_reward','referral_referee_reward']);
        if (!data) return {};
        const map = new Map(data.map((s)=>[s.key, s.value]));
        const toInt = (v)=>{
          if (v == null) return undefined;
          const s = typeof v === 'object' ? JSON.stringify(v) : String(v);
          const n = parseInt(s.replaceAll('"',''),10);
          return Number.isFinite(n) ? n : undefined;
        };
        return {
          referrerReward: toInt(map.get('referral_referrer_reward')),
          refereeReward:  toInt(map.get('referral_referee_reward')),
        };
      } catch { return {}; }
    }

    async function callProcessReferral(session, rc) {
      // 우선 invoke 사용(표시는 하지 않음)
      try {
        const { data, error } = await supabase.functions.invoke('process-referral', {
          body: { referralCode: rc },
          headers: { Authorization: `Bearer ${session.access_token}` }
        });
        if (error) throw new Error(error.message || 'invoke failed');
        return data;
      } catch (e1) {
        // 프록시 경로로 폴백(표시는 하지 않음)
        const url = `${FUNCTIONS_PROXY}/process-referral`;
        const resp = await fetch(url, {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization': `Bearer ${session.access_token}`,
            'apikey': SUPABASE_ANON_KEY,
          },
          body: JSON.stringify({ referralCode: rc }),
          mode:'cors'
        });
        const text = await resp.text().catch(()=> '');
        if (!resp.ok) {
          let msg = text;
          try { const j = JSON.parse(text); if (j?.error) msg = j.error; } catch {}
          throw new Error(msg || `${resp.status} ${resp.statusText}`);
        }
        try { return JSON.parse(text); } catch { return {}; }
      }
    }

    async function run() {
      // 1) 상단 완료 문구
      $('#headline').textContent = '가입 인증이 완료되었습니다.';
      // 2) 진행 상태
      setStatus('처리중입니다...', 'warn');

      const session = await ensureSession();
      if (!session) { setStatus('세션을 확인할 수 없습니다. 로그인 후 다시 시도해 주세요.', 'err'); return; }

      const rc = await detectReferralCode();
      if (!rc) { setStatus('추천 코드가 감지되지 않았습니다.', 'warn'); return; }

      try {
        // 중복 호출 최소화(최근 24시간 내 거래가 있으면 스킵)
        try {
          const since = new Date(Date.now() - 24*60*60*1000).toISOString();
          const { data: tx } = await supabase.from('coin_transactions').select('id').gte('created_at', since).limit(1);
          if (tx && tx.length>0) {
            // 이미 처리된 것으로 판단(최소화 목적). 그래도 성공 메시지로 마무리.
            // 추가로 관리자 설정 가져와 금액 표시를 시도.
            const fb = await getAdminRewardsFallback();
            const useAmt = (fb?.refereeReward ?? 0);
            if (useAmt > 0) setStatus(`추천 보상 +${useAmt} 이 적용되었습니다.`, 'ok');
            else setStatus('추천 보상이 적용되었습니다.', 'ok');
            return;
          }
        } catch {}

        const data = await callProcessReferral(session, rc);
        // 성공 처리
        if (data?.success) {
          // 금액은 함수 응답을 우선 사용, 없으면 admin_settings 폴백
          let amt = (typeof data.refereeReward === 'number') ? data.refereeReward : undefined;
          if (amt === undefined) {
            const fb = await getAdminRewardsFallback();
            amt = fb?.refereeReward;
          }
          if (typeof amt === 'number') {
            setStatus(`추천 보상 +${amt} 이 적용되었습니다.`, 'ok');
          } else {
            setStatus('추천 보상이 적용되었습니다.', 'ok');
          }
          localStorage.removeItem('pendingReferralCode');
        } else {
          setStatus('추천 보상 처리 결과를 확인할 수 없습니다.', 'warn');
        }
      } catch (e) {
        setStatus(`추천 보상 적용에 실패했습니다. ${e?.message || ''}`.trim(), 'err');
      }
    }

    window.addEventListener('DOMContentLoaded', run);
  </script>
</head>
<body>
  <div class="card">
    <h1 id="headline">가입 완료</h1>
    <div class="muted">Your registration has completed.</div>

    <div id="status" class="status">처리중입니다...</div>
  </div>
</body>
</html>

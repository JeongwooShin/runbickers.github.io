<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Runbickers | 계정 삭제 요청</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Arial, sans-serif; line-height: 1.5; padding: 16px; }
    .card { max-width: 520px; margin: 0 auto; border: 1px solid #ddd; border-radius: 8px; padding: 16px; }
    label { display: block; margin: 10px 0 4px; }
    input, textarea, select, button { width: 100%; padding: 10px; font-size: 14px; }
    button { margin-top: 14px; cursor: pointer; }
    .muted { color: #666; font-size: 12px; }
    .ok { color: #0a7a28; }
    .err { color: #b00020; white-space: pre-wrap; }
    .note { background: #f7f7f7; padding: 10px; border-radius: 6px; font-size: 13px; }
    .row { display: flex; gap: 8px; }
    .row > * { flex: 1; }
  </style>
</head>
<body>
  <div class="card">
    <h2>계정 삭제 요청</h2>
    <p class="note">
      - 운영용으로 메일을 보내려면 Resend에서 도메인(예: mail.runbickers.com)을 검증해야 합니다.<br />
      - 도메인 미검증 상태에서는 소유자 이메일로만 발송이 허용됩니다.
    </p>

    <form id="deleteForm" novalidate>
      <label for="email">이메일</label>
      <input id="email" name="email" type="email" required placeholder="email@example.com" />

      <label for="password">비밀번호</label>
      <input id="password" name="password" type="password" required />

      <div class="row">
        <div>
          <label for="nickname">닉네임(선택)</label>
          <input id="nickname" name="nickname" type="text" placeholder="선택 입력" />
        </div>
        <div>
          <label for="reason">사유(선택)</label>
          <select id="reason" name="reason">
            <option value="">선택 안 함</option>
            <option>앱 사용 빈도 낮음</option>
            <option>원하는 기능 부족</option>
            <option>개인정보 우려</option>
            <option>기타</option>
          </select>
        </div>
      </div>

      <button id="submitBtn" type="submit">회원탈퇴 확인 이메일 보내기</button>
      <div id="status" class="muted" style="margin-top:8px;"></div>
      <div id="msg" style="margin-top:8px;"></div>
    </form>
  </div>

  <script>
    // 환경값
    const FUNCTION_URL = 'https://sragibpyggwxbghyfuzq.functions.supabase.co/send-delete-confirm';
    // TODO: 실제 anon 키로 바꾸세요 (Project Settings → API → anon public)
    const ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

    const form = document.getElementById('deleteForm');
    const submitBtn = document.getElementById('submitBtn');
    const statusEl = document.getElementById('status');
    const msgEl = document.getElementById('msg');

    let submitting = false;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (submitting) return;

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const nickname = document.getElementById('nickname').value.trim();
      const reason = document.getElementById('reason').value;

      if (!email || !password) {
        msgEl.className = 'err';
        msgEl.textContent = '이메일과 비밀번호를 입력해 주세요.';
        return;
      }

      submitting = true;
      submitBtn.disabled = true;
      statusEl.textContent = '처리 중...';
      msgEl.textContent = '';
      msgEl.className = '';

      try {
        const res = await fetch(FUNCTION_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': ANON_KEY,
            'Authorization': `Bearer ${ANON_KEY}`,
          },
          body: JSON.stringify({ email, password, nickname, reason }),
        });

        let body = {};
        try { body = await res.json(); } catch (_) {}

        console.log('Response:', res.status, body);

        if (res.ok) {
          statusEl.textContent = '';
          msgEl.className = 'ok';
          msgEl.textContent = '확인 이메일을 보냈습니다. 메일함(스팸함 포함)을 확인해 주세요.';
          if (body.confirmUrl) {
            // 개발/테스트 모드에서만 내려올 수 있는 값
            const a = document.createElement('a');
            a.href = body.confirmUrl;
            a.textContent = '개발 모드: 바로 확인 링크 열기';
            a.target = '_blank';
            msgEl.appendChild(document.createElement('br'));
            msgEl.appendChild(a);
          }
          return;
        }

        // 에러 처리
        statusEl.textContent = '';
        msgEl.className = 'err';

        // Resend 테스트 제한/미검증 도메인
        if (res.status === 502 && body?.resend_status) {
          msgEl.textContent =
            '이메일 전송에 실패했습니다. ' +
            (body.resend_status === 403
              ? 'Resend 테스트 제한 또는 도메인 미검증 상태입니다. Domains에서 도메인을 검증하세요.'
              : `Resend 상태=${body.resend_status}. 상세: ${body.resend_error || ''}`);
          return;
        }

        if (res.status === 401) {
          msgEl.textContent = '이메일 또는 비밀번호가 올바르지 않습니다.';
          return;
        }

        msgEl.textContent = `요청 실패 (status=${res.status}). ${body?.error || ''}`;
      } catch (err) {
        statusEl.textContent = '';
        msgEl.className = 'err';
        msgEl.textContent = '네트워크 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.';
        console.error(err);
      } finally {
        submitting = false;
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
